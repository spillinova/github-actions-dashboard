<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Actions Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .workflow-card {
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        .workflow-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .run-item {
            border-left: 3px solid #dee2e6;
            padding-left: 1rem;
            margin-bottom: 0.75rem;
        }
        .run-item.success {
            border-left-color: #198754;
        }
        .run-item.failure {
            border-left-color: #dc3545;
        }
        .run-item.pending, .run-item.queued, .run-item.in_progress {
            border-left-color: #ffc107;
        }
        .avatar-sm {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        .repo-tab {
            cursor: pointer;
        }
        .repo-tab.active {
            font-weight: bold;
            border-bottom: 2px solid #0d6efd;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-github me-2"></i>GitHub Actions Dashboard
            </a>
            <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#addRepoModal">
                <i class="bi bi-plus-lg"></i> Add Repository
            </button>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Repositories</h5>
                        <button class="btn btn-sm btn-outline-primary" id="refreshRepos">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="list-group list-group-flush" id="repoList">
                        <div class="text-center p-3 text-muted" id="noReposMessage">
                            No repositories added yet. Click "Add Repository" to get started.
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div id="repoContent">
                    <div class="text-center p-5 text-muted">
                        <i class="bi bi-github" style="font-size: 3rem; opacity: 0.2;"></i>
                        <h4 class="mt-3">Select a repository to view workflows</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Repository Modal -->
    <div class="modal fade" id="addRepoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Repository</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="repoSearch" placeholder="Search repositories...">
                    </div>
                    <div class="list-group" id="availableRepos">
                        <div class="text-center p-3 text-muted">
                            Loading repositories...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedRepos = [];
        let currentRepo = null;

        // Load repositories from localStorage on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadRepos();
            loadAvailableRepos();
            
            // Set up refresh button
            document.getElementById('refreshRepos').addEventListener('click', () => {
                refreshAllRepos();
            });
            
            // Set up search
            document.getElementById('repoSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const repos = document.querySelectorAll('#availableRepos .list-group-item');
                
                repos.forEach(repo => {
                    const repoName = repo.querySelector('.repo-full-name').textContent.toLowerCase();
                    if (repoName.includes(searchTerm)) {
                        repo.style.display = 'flex';
                    } else {
                        repo.style.display = 'none';
                    }
                });
            });
        });

        // Load available repositories from GitHub
        async function loadAvailableRepos() {
            const container = document.getElementById('availableRepos');
            container.innerHTML = '<div class="text-center p-3 text-muted">Loading repositories...</div>';
            
            try {
                const response = await fetch('/api/repos');
                if (!response.ok) throw new Error('Failed to fetch repositories');
                
                const data = await response.json();
                
                if (data.repos && data.repos.length > 0) {
                    container.innerHTML = '';
                    data.repos.forEach(repo => {
                        const isSelected = selectedRepos.some(r => r.id === `${repo.owner}/${repo.name}`);
                        const repoElement = document.createElement('div');
                        repoElement.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${isSelected ? 'active' : ''}`;
                        repoElement.innerHTML = `
                            <div class="d-flex flex-column">
                                <span class="repo-full-name">${repo.full_name}</span>
                                <small class="text-muted">${repo.description || 'No description'}</small>
                            </div>
                            <button class="btn btn-sm ${isSelected ? 'btn-outline-light' : 'btn-primary'}" 
                                    onclick="addRepo('${repo.owner}', '${repo.name}')" 
                                    ${isSelected ? 'disabled' : ''}>
                                ${isSelected ? 'Added' : 'Add'}
                            </button>
                        `;
                        container.appendChild(repoElement);
                    });
                } else {
                    container.innerHTML = '<div class="text-center p-3 text-muted">No repositories found.</div>';
                }
            } catch (error) {
                console.error('Error loading repositories:', error);
                container.innerHTML = `<div class="text-center p-3 text-danger">Error loading repositories: ${error.message}</div>`;
            }
        }

        // Add a repository to the dashboard
        async function addRepo(owner, name) {
            try {
                const response = await fetch('/api/repos/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ owner, name })
                });
                
                if (!response.ok) throw new Error('Failed to add repository');
                
                const data = await response.json();
                selectedRepos = data.selected_repos;
                saveRepos();
                renderRepos();
                loadAvailableRepos();
                
                // If this is the first repo, select it
                if (selectedRepos.length === 1) {
                    selectRepo(selectedRepos[0].id);
                }
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addRepoModal'));
                modal.hide();
            } catch (error) {
                console.error('Error adding repository:', error);
                alert(`Error adding repository: ${error.message}`);
            }
        }

        // Remove a repository from the dashboard
        function removeRepo(repoId, event) {
            event.stopPropagation();
            selectedRepos = selectedRepos.filter(repo => repo.id !== repoId);
            saveRepos();
            renderRepos();
            
            // If the removed repo was selected, clear the content
            if (currentRepo === repoId) {
                currentRepo = null;
                document.getElementById('repoContent').innerHTML = `
                    <div class="text-center p-5 text-muted">
                        <i class="bi bi-github" style="font-size: 3rem; opacity: 0.2;"></i>
                        <h4 class="mt-3">Select a repository to view workflows</h4>
                    </div>
                `;
            }
        }

        // Select a repository to view its workflows
        async function selectRepo(repoId) {
            currentRepo = repoId;
            const [owner, name] = repoId.split('/');
            
            // Update active state
            document.querySelectorAll('#repoList .list-group-item').forEach(item => {
                item.classList.toggle('active', item.dataset.repoId === repoId);
            });
            
            // Show loading state
            const content = document.getElementById('repoContent');
            content.innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading workflows for ${repoId}...</p>
                </div>
            `;
            
            try {
                // Fetch workflows for the selected repo
                const response = await fetch(`/api/workflows/${owner}/${name}`);
                if (!response.ok) throw new Error('Failed to fetch workflows');
                
                const data = await response.json();
                renderWorkflows(owner, name, data.workflows);
            } catch (error) {
                console.error('Error loading workflows:', error);
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Error loading workflows</h5>
                        <p>${error.message}</p>
                        <button class="btn btn-sm btn-outline-secondary" onclick="selectRepo('${repoId}')">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // Render the list of repositories in the sidebar
        function renderRepos() {
            const container = document.getElementById('repoList');
            
            if (selectedRepos.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-3 text-muted" id="noReposMessage">
                        No repositories added yet. Click "Add Repository" to get started.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            selectedRepos.forEach(repo => {
                const repoElement = document.createElement('div');
                repoElement.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${currentRepo === repo.id ? 'active' : ''}`;
                repoElement.dataset.repoId = repo.id;
                repoElement.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-github me-2"></i>
                        <span>${repo.name}</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeRepo('${repo.id}', event)">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                
                repoElement.addEventListener('click', () => selectRepo(repo.id));
                container.appendChild(repoElement);
            });
        }

        // Render workflows for the selected repository
        function renderWorkflows(owner, repoName, workflows) {
            if (!workflows || workflows.length === 0) {
                document.getElementById('repoContent').innerHTML = `
                    <div class="alert alert-info">
                        No workflows found for ${owner}/${repoName}.
                    </div>
                `;
                return;
            }
            
            const workflowsHtml = workflows.map(workflow => `
                <div class="card workflow-card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${workflow.name}</h5>
                        <span class="badge bg-${getStatusBadgeClass(workflow.latest_run?.conclusion || workflow.state)}">
                            ${workflow.latest_run?.conclusion || workflow.state}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6>Latest Runs</h6>
                            <div id="runs-${workflow.id}">
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Loading runs...</span>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> Updated ${new Date(workflow.updated_at).toLocaleString()}
                            </small>
                            <a href="https://github.com/${owner}/${repoName}/actions/workflows/${workflow.path.split('/').pop()}" 
                               target="_blank" class="btn btn-sm btn-outline-primary">
                                View on GitHub
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('repoContent').innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>${owner}/${repoName}</h3>
                    <button class="btn btn-outline-secondary" onclick="selectRepo('${owner}/${repoName}')">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                ${workflowsHtml}
            `;
            
            // Load runs for each workflow
            workflows.forEach(workflow => {
                loadWorkflowRuns(owner, repoName, workflow.id);
            });
        }

        // Load runs for a specific workflow
        async function loadWorkflowRuns(owner, repoName, workflowId) {
            const container = document.getElementById(`runs-${workflowId}`);
            if (!container) return;
            
            try {
                const response = await fetch(`/api/runs/${owner}/${repoName}/${workflowId}?per_page=5`);
                if (!response.ok) throw new Error('Failed to fetch workflow runs');
                
                const data = await response.json();
                
                if (!data.runs || data.runs.length === 0) {
                    container.innerHTML = '<div class="text-muted">No runs found for this workflow.</div>';
                    return;
                }
                
                const runsHtml = data.runs.map(run => `
                    <div class="run-item ${run.status} ${run.conclusion || ''}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>#${run.run_number}</strong> ${run.event}
                                <span class="badge bg-${getStatusBadgeClass(run.conclusion || run.status)}">
                                    ${run.conclusion || run.status}
                                </span>
                            </div>
                            <div class="d-flex align-items-center">
                                ${run.triggering_actor ? `
                                    <img src="${run.triggering_actor.avatar_url}" class="avatar-sm me-1" 
                                         alt="${run.triggering_actor.login}" title="${run.triggering_actor.login}">
                                ` : ''}
                                <small class="text-muted">
                                    ${new Date(run.created_at).toLocaleString()}
                                </small>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">
                                <a href="${run.html_url}" target="_blank" class="text-decoration-none">
                                    <i class="bi bi-link-45deg"></i> View run
                                </a>
                            </small>
                            <small class="text-muted">
                                ${timeAgo(new Date(run.updated_at))}
                            </small>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = runsHtml;
            } catch (error) {
                console.error('Error loading workflow runs:', error);
                container.innerHTML = `
                    <div class="alert alert-danger p-2">
                        <small>Error loading runs: ${error.message}</small>
                    </div>
                `;
            }
        }

        // Refresh all repositories
        async function refreshAllRepos() {
            if (!currentRepo) return;
            selectRepo(currentRepo);
        }

        // Helper function to get badge class based on status
        function getStatusBadgeClass(status) {
            if (!status) return 'secondary';
            
            const statusLower = status.toLowerCase();
            if (statusLower === 'success' || statusLower === 'completed') return 'success';
            if (statusLower === 'failure' || statusLower === 'cancelled' || statusLower === 'timed_out') return 'danger';
            if (statusLower === 'pending' || statusLower === 'queued' || statusLower === 'in_progress') return 'warning';
            if (statusLower === 'action_required') return 'info';
            return 'secondary';
        }

        // Helper function to format time ago
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval >= 1) return interval + ' years ago';
            
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return interval + ' months ago';
            
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return interval + ' days ago';
            
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + ' hours ago';
            
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + ' minutes ago';
            
            return 'just now';
        }

        // Save repositories to localStorage
        function saveRepos() {
            localStorage.setItem('github_actions_dashboard_repos', JSON.stringify(selectedRepos));
        }

        // Load repositories from localStorage
        function loadRepos() {
            const savedRepos = localStorage.getItem('github_actions_dashboard_repos');
            if (savedRepos) {
                selectedRepos = JSON.parse(savedRepos);
                if (selectedRepos.length > 0) {
                    renderRepos();
                    // Select the first repo by default
                    selectRepo(selectedRepos[0].id);
                }
            }
        }
    </script>
</body>
</html>
